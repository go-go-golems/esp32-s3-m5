# Tasks

## TODO

### Milestone: “pair a keyboard, type, see keys over serial”

- [x] Create new firmware project `esp32-s3-m5/0020-cardputer-ble-keyboard-host/` (CMakeLists, `main/`, `sdkconfig.defaults`, `partitions.csv`)
- [x] Enable required SDK config defaults:
  - [x] `CONFIG_ESP_CONSOLE_USB_SERIAL_JTAG=y` (and disable UART/USB-CDC consoles)
  - [x] Bluedroid BLE + GATTC enabled (Central mode)
  - [x] Enable/verify `esp_hid` host component is included in build
- [x] Implement BLE bring-up (NVS → controller → bluedroid → callbacks) in `ble_host.c`
  - [x] `esp_ble_gap_register_callback(gap_cb)`
  - [x] `esp_ble_gattc_register_callback(gattc_cb)` + `esp_ble_gattc_app_register(APP_ID)`
- [x] Implement “device registry” for scan results (bounded list + last-seen + addr type + RSSI + name)
  - [x] Parse ADV name via `esp_ble_resolve_adv_data_by_type(...)`
  - [ ] Add simple “kbd?” heuristic (appearance/service UUID when available)
- [x] Implement scanning control:
  - [x] `scan on [seconds]` starts scan (`esp_ble_gap_set_scan_params` + `esp_ble_gap_start_scanning`)
  - [x] `scan off` stops scan (`esp_ble_gap_stop_scanning`)
  - [x] `devices` prints the registry in a stable table format
- [x] Integrate ESP-IDF HID Host (`esp_hidh`) in `hid_host.c`
  - [x] `esp_hidh_init()` with an `esp_event_handler_t` callback for `ESP_HIDH_EVENTS`
  - [x] In `gattc_cb`, forward events to HID host via `esp_hidh_gattc_event_handler(...)`
  - [x] Handle `ESP_HIDH_OPEN_EVENT`, `ESP_HIDH_INPUT_EVENT`, `ESP_HIDH_CLOSE_EVENT` (`esp_hidh_dev_free(dev)` on close)
- [x] Implement connect/disconnect:
  - [x] `connect <index|addr>` calls `esp_hidh_dev_open(bda, ESP_HID_TRANSPORT_BLE, addr_type)`
  - [x] `disconnect [addr]` calls `esp_hidh_dev_close(dev)` (plus cleanup state)
- [x] Implement pairing + bonds:
  - [x] Set baseline security policy via `esp_ble_gap_set_security_param(...)` (bonding policy)
  - [x] `pair <addr>` initiates encryption/pairing (`esp_ble_set_encryption(...)`)
  - [x] `bonds` lists bonded devices (`esp_ble_get_bond_device_num`, `esp_ble_get_bond_device_list`)
  - [x] `unpair <addr>` removes bond (`esp_ble_remove_bond_device`)
  - [x] Support interactive security prompts:
    - [x] `sec-accept <addr> yes|no` → `esp_ble_gap_security_rsp(...)`
    - [x] `passkey <addr> <6digits>` → `esp_ble_passkey_reply(...)`
    - [x] `confirm <addr> yes|no` → `esp_ble_confirm_reply(...)`
- [x] Implement key logging to serial:
  - [x] Add a `keylog on|off` command to gate output spam
  - [x] Parse common boot keyboard reports (modifiers + 6 keycodes) and print:
    - [x] raw report dump (hex) for debugging
    - [x] decoded key events (down/up)
    - [x] optional ASCII when mapping is possible (US layout as first pass)
  - [x] Avoid printing in BLE callbacks directly: enqueue reports to a keylog task/queue
- [ ] Implement `info` command:
  - [ ] Current state (scanning/connecting/connected)
  - [ ] Selected device (addr, addr_type, name, bonded?, trusted?)
  - [ ] Security last result (auth complete status)
- [ ] Implement “trust” policy (optional for milestone, but useful):
  - [ ] `trust <addr>` / `untrust <addr>` sets an NVS flag keyed by address
  - [ ] Auto-reconnect only if trusted
- [ ] Write a minimal playbook for humans in `playbooks/`:
  - [ ] Flash + monitor commands
  - [ ] Example session: `scan on`, `devices`, `connect`, `pair`, `keylog on`
- [x] [Dual-mode] Decide scope: Classic-only vs BTDM (dual-mode) keyboard host
- [ ] [Dual-mode] Enable Classic + HID Host in sdkconfig.defaults (CONFIG_BT_CLASSIC_ENABLED=y, CONFIG_BT_HID_HOST_ENABLED=y)
- [ ] [Dual-mode] Switch controller mode to ESP_BT_MODE_BTDM (stop releasing Classic mem; update ble_host_init/renamed host init)
- [ ] [Dual-mode] Implement Classic discovery registry (inquiry) + console commands: scan bredr, devices bredr
- [ ] [Dual-mode] Implement Classic pairing prompts/handlers (PIN + SSP): expose console replies analogous to sec-accept/passkey/confirm
- [ ] [Dual-mode] Add Classic bonds management: bonds bredr, unpair bredr (esp_bt_gap_get_bond_device_list/remove_bond_device)
- [ ] [Dual-mode] Open keyboards via esp_hidh transport selection (ESP_HID_TRANSPORT_BT vs _BLE) based on discovery record
- [ ] [Dual-mode] Add unified peer registry (peers) that merges: BLE scan registry, BR/EDR inquiry registry, BLE bonds, BR/EDR bonds
- [ ] [Dual-mode] Define mapping rules (no CTKD assumptions): how a Classic peer and LE peer may or may not map to one physical device
- [ ] [Dual-mode] Update playbook: how to use scan le/bredr, peers, connect/pair for both transports
- [ ] [Dual-mode] Validation matrix: test with one Classic-only keyboard and one BLE HOGP keyboard; record expected console traces
- [ ] [Dual-mode] Hardware constraint: ESP32-S3 is BLE-only; if BR/EDR keyboards are required, switch target/hardware to ESP32 (Classic-capable)
