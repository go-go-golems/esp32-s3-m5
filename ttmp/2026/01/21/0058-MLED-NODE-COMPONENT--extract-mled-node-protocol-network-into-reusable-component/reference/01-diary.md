---
Title: Diary
Ticket: 0058-MLED-NODE-COMPONENT
Status: active
Topics:
    - esp32c6
    - esp-idf
    - networking
    - protocol
    - tooling
DocType: reference
Intent: long-term
Owners: []
RelatedFiles:
    - Path: 0049-xiao-esp32c6-mled-node/CMakeLists.txt
      Note: EXTRA_COMPONENT_DIRS wiring to consume mled_node component
    - Path: 0049-xiao-esp32c6-mled-node/main/CMakeLists.txt
      Note: main depends on mled_node component
    - Path: components/mled_node/include/mled_node.h
      Note: Component API surface and callback/status types
    - Path: components/mled_node/src/mled_node.c
      Note: UDP multicast node loop and protocol handlers
ExternalSources: []
Summary: ""
LastUpdated: 2026-01-21T15:40:49.40766084-05:00
WhatFor: Record the component API decisions, extraction steps, commits, and validation results.
WhenToUse: Use when reviewing or extending the component, or reproducing the validation procedure in a downstream firmware.
---


# Diary

## Goal

Capture the end-to-end work log for ticket `0058-MLED-NODE-COMPONENT`: extracting the MLED node protocol and UDP multicast networking logic from the `0049-xiao-esp32c6-mled-node` tutorial into a reusable `esp32-s3-m5/components/` component, and validating that the tutorial still builds and behaves the same.

## Context

Current state (before extraction):
- The `0049-xiao-esp32c6-mled-node` firmware implements:
  - MLED/1 wire structs + pack/unpack (`mled_protocol.*`)
  - show-time wrap-around helpers (`mled_time.*`)
  - UDP multicast node loop + handlers (`mled_node.*`)
- The intent is to reuse the node protocol stack across multiple firmwares without copy/paste.

## Step 1: Create ticket workspace + define extraction tasks

Created the docmgr workspace and wrote an explicit checklist for the extraction: define API, create component skeleton, move code, update 0049 to depend on it, and validate build/flash behavior.

### What I did
- Created ticket `0058-MLED-NODE-COMPONENT`.
- Added documents (diary, design doc, validation playbook).
- Updated `tasks.md` with an extraction checklist.

### Why
- Componentization is easiest when broken into mechanical steps with clear validation gates.

### What should be done next
- Decide the component API surface and Kconfig naming, then begin the extraction.

## Related

- Source tutorial to extract from: `esp32-s3-m5/0049-xiao-esp32c6-mled-node/`

## Step 2: Extract protocol/network code into a reusable component

This step moves the MLED/1 protocol structs, time helpers, and UDP multicast node loop into a new `components/mled_node` ESP-IDF component, keeping the behavior the same while making it reusable across firmwares. The downstream `0049-xiao-esp32c6-mled-node` tutorial now depends on the component instead of owning the sources.

The key build-system detail is that ESP-IDF “extra component dirs” are *component roots*, and pulling in a broad shared directory can accidentally include unrelated components (and their dependencies). For `0049` we point `EXTRA_COMPONENT_DIRS` specifically at the single component directory to avoid dependency fan-out.

**Commit (code):** 5cfb36f — "mled_node: extract node protocol/network into component"

### What I did
- Created `esp32-s3-m5/components/mled_node/` with:
  - `include/` headers (`mled_node.h`, `mled_protocol.h`, `mled_time.h`)
  - `src/` sources (`mled_node.c`, `mled_protocol.c`, `mled_time.c`)
  - `CMakeLists.txt` + `Kconfig`
- Removed the now-duplicated node/protocol/time sources from `0049-xiao-esp32c6-mled-node/main/`.
- Updated `0049-xiao-esp32c6-mled-node/main/CMakeLists.txt` to depend on `mled_node`.
- Updated `0049-xiao-esp32c6-mled-node/main/Kconfig.projbuild` to drop the node-name/time-req knobs (moved to component Kconfig).
- Updated `0049-xiao-esp32c6-mled-node/CMakeLists.txt` to add:
  - `set(EXTRA_COMPONENT_DIRS "${CMAKE_CURRENT_LIST_DIR}/../components/mled_node")`
- Captured `0049-xiao-esp32c6-mled-node/dependencies.lock` generated by ESP-IDF’s dependency solver during build.

### Why
- We want to reuse the MLED/1 node stack across multiple firmwares (and eventually multiple boards) without copy/paste drift.
- Extracting into `components/` makes the node stack versionable and testable as a unit.

### What worked
- The extraction stayed mechanical: behavior preserved, with the “application hook” (`mled_node_set_on_apply`) still being the handoff point where a firmware can enqueue pattern work (LED task, audio task, etc.).

### What didn't work
- Initial build attempt failed when the component wasn't on the project’s component search path:
  - `Failed to resolve component 'mled_node' required by component 'main': unknown name.`
- A follow-up attempt using a broad shared extra dir (`../components`) caused ESP-IDF to discover unrelated components and fail resolving their dependencies:
  - `Failed to resolve component 'M5GFX' required by component 'echo_gif': unknown name.`
- Fix: point `EXTRA_COMPONENT_DIRS` at the single component directory (`../components/mled_node`) for the `0049` tutorial.

### What I learned
- `EXTRA_COMPONENT_DIRS` should be narrowly scoped in this repo, because `esp32-s3-m5/components/` contains heterogeneous components for different boards/features.

### What was tricky to build
- Avoiding accidental component inclusion: ESP-IDF discovers components under the extra dirs and may try to resolve their declared requirements even if the current project doesn’t intend to use them.

### What warrants a second pair of eyes
- The component API boundary: confirm `mled_node_set_effect_status()` is the right direction (controller-visible state is separated from whatever internal effect engine runs).
- Thread-safety assumptions: callbacks must remain non-blocking and should never call networking directly.

### What should be done in the future
- Add a tiny example consumer other than `0049` (to prove the component works cross-project).

### Code review instructions
- Start at `esp32-s3-m5/components/mled_node/include/mled_node.h` and `esp32-s3-m5/components/mled_node/src/mled_node.c`.
- Confirm `0049-xiao-esp32c6-mled-node` no longer ships protocol/network sources under `main/`.

### Technical details
- Component Kconfig prefix: `CONFIG_MLED_NODE_*` (intentionally reusable; not tutorial-specific).

## Step 3: Validate that 0049 still builds with the component

This step validates the extraction at the first gate: the `0049-xiao-esp32c6-mled-node` firmware must still compile and link when `mled_node` is provided via `EXTRA_COMPONENT_DIRS`.

### What I did
- Built `0049-xiao-esp32c6-mled-node` against ESP-IDF v5.4.1:
  - `cd esp32-s3-m5/0049-xiao-esp32c6-mled-node`
  - `. $HOME/esp/esp-idf-5.4.1/export.sh >/dev/null 2>&1`
  - `idf.py build`

### Why
- This is the minimal validation that the build system, includes, and link dependencies are correct.

### What worked
- `idf.py build` completed successfully and produced `build/xiao_esp32c6_mled_node_0049.bin`.

### What didn't work
- N/A (after narrowing `EXTRA_COMPONENT_DIRS`, the build was clean).

### What I learned
- The component extraction is “wiring-correct” for ESP-IDF 5.4.1 and the ESP32-C6 target.

### What was tricky to build
- Ensuring the component search path stays narrow enough to avoid unrelated component dependency resolution.

### What warrants a second pair of eyes
- Confirm we want to commit `dependencies.lock` for tutorials consistently (this repo appears to do so widely, but review preference matters).

### What should be done in the future
- Validate the runtime behavior gate: flash + host `mled_ping.py` / `mled_smoke.py` against real hardware.

### Code review instructions
- Build locally:
  - `cd esp32-s3-m5/0049-xiao-esp32c6-mled-node`
  - `. $HOME/esp/esp-idf-5.4.1/export.sh`
  - `idf.py build`

### Technical details
- The discovered-components explosion was avoided by setting:
  - `EXTRA_COMPONENT_DIRS = ../components/mled_node` (not `../components`).

## Step 4: Validate runtime behavior on real hardware (flash + host smoke)

This step validates the second gate: that the extracted component still behaves correctly when flashed to an ESP32‑C6 and driven by the host Python tools. The goal is to confirm the end-to-end control loop is intact: Wi‑Fi join, multicast receive, unicast replies, BEACON epoch/time gating, TIME_REQ/RESP refinement, cue prepare/ack, and cue fire/apply.

**Commit (code):** 5cfb36f — "mled_node: extract node protocol/network into component" (no code changes in this validation step)

### What I did
- Flashed `0049-xiao-esp32c6-mled-node` to a XIAO ESP32C6 and monitored logs.
- Provisioned Wi‑Fi via the console and confirmed STA IP assignment.
- Ran host smoke tests:
  - `python3 tools/mled_ping.py`
  - `python3 tools/mled_smoke.py`
- Captured key device log lines showing:
  - node startup (`started: id=... group=239.255.32.6:4626`)
  - TIME_RESP refinement with RTT measurements and updated offsets
  - cue lifecycle: `CUE_PREPARE`, `CUE_FIRE`, and `APPLY`

### Why
- The build can succeed while runtime behavior is broken (multicast join, socket options, endian issues, time math).
- This provides high confidence that `components/mled_node` is safe to reuse in other projects.

### What worked
- The full flow worked on hardware:
  - GOT_IP triggered node start
  - TIME_REQ/RESP refinement converged quickly (single-digit to tens of ms RTT)
  - Cue prepare/fire executed and applied close to the scheduled show-time

### What didn't work
- N/A (there was a Wi‑Fi warning line, but it did not affect protocol behavior).

### What I learned
- The component boundary did not introduce any latent timing/regression issues; protocol state is preserved across the refactor.

### What was tricky to build
- N/A (validation-only step).

### What warrants a second pair of eyes
- Show-time offset magnitude can look “surprisingly large” in logs; that’s expected when the controller uses a long-running monotonic clock. What matters operationally is RTT and that scheduled `execute_at` aligns with `APPLY`.

### What should be done in the future
- Add an optional “debug hook” to emit a compact periodic status line (epoch, offset, drift estimate) for long-running sync verification.

### Code review instructions
- Follow the playbook:
  - `ttmp/2026/01/21/0058-MLED-NODE-COMPONENT--extract-mled-node-protocol-network-into-reusable-component/playbook/01-playbook-validate-component-in-0049.md`
- Confirm log lines for TIME_RESP + APPLY appear as expected.

### Technical details
- Example observed log excerpt (device):
  - `mled_node: started: id=3019688450 name=c6-node group=239.255.32.6:4626`
  - `mled_node: TIME_RESP req_id=1 rtt=6ms new_offset=...`
  - `mled_node: CUE_PREPARE cue=42 pattern=1 bri=25%`
  - `mled_node: CUE_FIRE cue=42 execute_at=...`
  - `mled_node: APPLY cue=42 pattern=1 bri=25% show_ms=...`
